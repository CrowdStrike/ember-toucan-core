<Velcro
  @middleware={{this.velcroMiddleware}}
  @placement="bottom-start"
  as |velcro|
>
  <div class="relative flex items-center">
    <input
      aria-activedescendant={{this.activeDescendant}}
      aria-autocomplete="list"
      aria-controls={{this.popoverId}}
      aria-expanded={{this.isPopoverOpen}}
      aria-haspopup="listbox"
      autocapitalize="none"
      autocomplete="off"
      autocorrect="off"
      class="focus:outline-none bg-overlay-1 w-full rounded-sm border-none py-1 pl-2 pr-6 transition-shadow
        {{this.styles}}"
      disabled={{@isDisabled}}
      readonly={{@isReadOnly}}
      role="combobox"
      spellcheck="false"
      value={{this.inputValue}}
      {{on
        "blur"
        (if
          this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.closePopover
        )
      }}
      {{on
        "blur"
        (if this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.resetValue)
      }}
      {{on
        "click"
        (if
          this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.openPopover
        )
      }}
      {{on
        "focus"
        (if
          this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.openPopover
        )
      }}
      {{on
        "keydown"
        (if this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.onKeydown)
      }}
      {{on
        "input"
        (if this.isDisabledOrReadOnlyOrWithoutOptions this.noop this.onInput)
      }}
      {{velcro.hook}}
      ...attributes
    />

    <this.Chevron
      class="pointer-events-none absolute right-1 top-0 ml-auto h-full transform transition-transform duration-200
        {{if this.isPopoverOpen 'rotate-180'}}"
    />
  </div>

  {{#if this.isPopoverOpen}}
    <ul
      class="border-surface-inner bg-surface-2xl max-h-listbox my-0 list-none overflow-y-auto overscroll-contain rounded-sm border py-1 pl-0 shadow-xl
        {{if @contentClass @contentClass}}"
      id={{this.popoverId}}
      role="listbox"
      {{velcro.loop}}
    >
      {{#each this.options as |option index|}}
        {{yield
          (hash
            Option=(component
              (ensure-safe-component this.Option)
              isActive=(this.isEqual index this.activeIndex)
              isDisabled=@isDisabled
              isSelected=(this.isEqual @selected option)
              isReadOnly=@isReadOnly
              onClick=(fn this.onChange index)
              onMouseover=(fn this.onOptionMouseover index)
              popoverId=this.popoverId
              index=index
            )
            option=option
          )
        }}
      {{/each}}
    </ul>
  {{/if}}
</Velcro>